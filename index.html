<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CineFlow | Studio Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        :root { 
            --bg-color: #121212; 
            --grid-color: rgba(255,255,255,0.05);
            --text-color: white;
            --glass-bg: rgba(18, 18, 18, 0.85);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent: #00f3ff;
        }

        body.light-mode {
            --bg-color: #e5e7eb;
            --grid-color: rgba(0,0,0,0.05);
            --text-color: #1f2937;
            --glass-bg: rgba(255,255,255,0.9);
            --glass-border: rgba(0, 0, 0, 0.1);
            --accent: #0ea5e9;
        }

        body { 
            background-color: var(--bg-color); 
            color: var(--text-color);
            margin: 0; overflow: hidden; touch-action: none; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            user-select: none; -webkit-user-select: none;
            transition: background-color 0.3s;
        }
        
        /* VIEWPORT & GRID */
        #viewport { width: 100vw; height: 100vh; cursor: grab; overflow: hidden; position: relative; touch-action: none; }
        #world { position: absolute; top: 50%; left: 50%; width: 0; height: 0; transform-origin: 0 0; }
        #grid-pattern {
            position: absolute; top: -5000px; left: -5000px; width: 10000px; height: 10000px;
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none; z-index: -1;
        }

        /* OBJECTS */
        .scene-object {
            position: absolute; transform-origin: center center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: grab; z-index: 10;
        }
        /* Selection Ring */
        .scene-object.selected .object-visual {
            outline: 2px solid var(--accent);
            box-shadow: 0 0 15px var(--accent);
        }
        
        /* CONTROLS (Handles) */
        .control-handle {
            position: absolute; width: 24px; height: 24px;
            background: white; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: black;
            z-index: 20; transform: scale(0); transition: transform 0.2s;
        }
        .selected .control-handle { transform: scale(1); }
        .rotate-handle { top: -30px; cursor: url('https://www.svgrepo.com/show/532997/rotate-right.svg'), auto; }
        .resize-handle { bottom: -20px; right: -20px; cursor: se-resize; }

        /* CAMERA */
        .fov-cone {
            position: absolute; bottom: 50%; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 100px solid transparent; border-right: 100px solid transparent;
            border-top: 300px solid rgba(0, 243, 255, 0.15);
            pointer-events: none; transform-origin: bottom center;
        }
        .cam-body {
            width: 40px; height: 26px; background: var(--accent); border-radius: 4px;
            position: relative; z-index: 2;
        }
        
        /* PROPS */
        .prop-visual {
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px;
            transition: all 0.2s;
        }
        /* Light Mode Prop Visibility Fix */
        body.light-mode .prop-visual { color: #333; border-color: #999; }
        body.light-mode .prop-visual i { color: #333 !important; }

        /* UI PANELS */
        .glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); color: var(--text-color);
        }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* TARGET LOCK LINE */
        .target-line {
            position: absolute; height: 1px; background: var(--accent);
            transform-origin: 0 50%; opacity: 0.5; pointer-events: none; stroke-dasharray: 4;
        }
    </style>
</head>
<body>

    <div id="viewport">
        <div id="world">
            <div id="grid-pattern"></div>
            <div id="lines-layer" style="position: absolute; top:0; left:0; width:0; height:0;"></div>
            </div>
    </div>

    <div class="fixed top-0 left-0 w-full p-4 flex justify-between items-start pointer-events-none z-50">
        <div class="flex gap-2 pointer-events-auto">
            <button onclick="toggleSceneMenu()" class="glass-panel px-4 py-2 rounded-xl shadow-lg flex items-center gap-2 hover:bg-white/10 transition">
                <i class="fa-solid fa-folder-open text-xs"></i>
                <span class="text-xs font-bold uppercase" id="scene-name-display">Untitled Scene</span>
            </button>
            <button onclick="saveScene()" class="glass-panel w-9 h-9 rounded-xl flex items-center justify-center hover:bg-green-500/20 hover:text-green-400 transition">
                <i class="fa-solid fa-save text-xs"></i>
            </button>
        </div>

        <div class="flex gap-2 pointer-events-auto">
             <button onclick="playScene()" class="glass-panel px-3 py-2 rounded-xl flex items-center gap-2 text-[10px] font-bold text-green-400 hover:text-green-300 transition">
                <i class="fa-solid fa-clapperboard"></i> ACTION
            </button>
            <button onclick="toggleTheme()" class="glass-panel w-9 h-9 rounded-xl flex items-center justify-center active:scale-90 transition">
                <i class="fa-solid fa-moon" id="theme-icon"></i>
            </button>
        </div>
    </div>

    <div id="scene-menu" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="glass-panel w-96 rounded-2xl p-6 relative">
            <button onclick="toggleSceneMenu()" class="absolute top-4 right-4 opacity-50"><i class="fa-solid fa-xmark"></i></button>
            <h2 class="text-sm font-bold uppercase tracking-widest mb-4">Scene Management</h2>
            
            <div class="mb-4">
                <label class="text-[10px] uppercase opacity-50 font-bold">Current Scene Name</label>
                <input type="text" id="scene-name-input" class="w-full bg-white/5 border border-white/10 rounded p-2 text-xs mt-1" placeholder="e.g. Sc 1 - INT. Cafe">
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="createNewScene()" class="p-3 bg-cyan-500/20 border border-cyan-500/30 rounded-xl text-xs font-bold text-cyan-400 hover:bg-cyan-500/30">
                    <i class="fa-solid fa-plus block mb-1"></i> New Scene
                </button>
                <button onclick="downloadScene()" class="p-3 bg-white/5 border border-white/10 rounded-xl text-xs font-bold hover:bg-white/10">
                    <i class="fa-solid fa-download block mb-1"></i> Export JSON
                </button>
            </div>

            <h3 class="text-[10px] uppercase opacity-50 font-bold mb-2">Saved Scenes</h3>
            <div id="saved-list" class="max-h-40 overflow-y-auto space-y-2">
                </div>
        </div>
    </div>

    <div class="fixed bottom-8 left-1/2 -translate-x-1/2 glass-panel rounded-full p-2 flex gap-2 shadow-2xl z-50">
        <button onclick="addObject('actor')" class="flex flex-col items-center justify-center w-16 h-14 rounded-2xl hover:bg-white/5 active:bg-white/10 transition">
            <div class="w-4 h-4 rounded-full bg-rose-500 mb-1 shadow-sm"></div>
            <span class="text-[9px] font-bold opacity-70">ACTOR</span>
        </button>
        <div class="w-px h-10 bg-white/10 my-auto"></div>
        <button onclick="addObject('camera')" class="flex flex-col items-center justify-center w-16 h-14 rounded-2xl hover:bg-white/5 active:bg-white/10 transition">
            <div class="w-5 h-3 rounded-sm bg-cyan-400 mb-1 shadow-sm"></div>
            <span class="text-[9px] font-bold opacity-70">CAMERA</span>
        </button>
        <div class="w-px h-10 bg-white/10 my-auto"></div>
        <button onclick="openPropPicker()" class="flex flex-col items-center justify-center w-16 h-14 rounded-2xl hover:bg-white/5 active:bg-white/10 transition">
            <div class="w-4 h-4 border border-amber-400 mb-1 shadow-sm"></div>
            <span class="text-[9px] font-bold opacity-70">PROP</span>
        </button>
    </div>

    <div id="prop-picker" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center backdrop-blur-sm" onclick="if(event.target.id==='prop-picker') this.classList.add('hidden')">
        <div class="glass-panel w-[90vw] max-w-md h-[70vh] rounded-3xl overflow-hidden flex flex-col animate-[fadeIn_0.2s]">
            <div class="p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-xs font-bold uppercase tracking-widest">Prop Warehouse</h3>
                <span class="text-[9px] opacity-50">150+ Items</span>
            </div>
            <div class="p-2 flex gap-2 overflow-x-auto border-b border-white/10 hide-scroll">
                <button onclick="filterProps('all')" class="px-3 py-1 bg-white/10 rounded-full text-[10px]">All</button>
                <button onclick="filterProps('furniture')" class="px-3 py-1 bg-white/5 rounded-full text-[10px]">Furniture</button>
                <button onclick="filterProps('set')" class="px-3 py-1 bg-white/5 rounded-full text-[10px]">Set</button>
                <button onclick="filterProps('street')" class="px-3 py-1 bg-white/5 rounded-full text-[10px]">Street</button>
            </div>
            <div id="prop-grid" class="p-4 overflow-y-auto grid grid-cols-4 gap-3 content-start"></div>
        </div>
    </div>

    <div id="inspector" class="fixed right-4 top-1/2 -translate-y-1/2 w-72 glass-panel rounded-3xl p-5 translate-x-[150%] transition-transform duration-300 shadow-2xl z-50">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xs font-bold opacity-50 uppercase">Properties</h2>
            <button onclick="closeInspector()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        
        <div class="mb-4">
            <label class="text-[9px] uppercase font-bold opacity-50">Label</label>
            <input type="text" id="insp-name" class="w-full bg-white/5 border border-white/10 rounded p-2 text-xs" oninput="updateLabel(this.value)">
        </div>

        <div id="cam-controls" class="hidden mb-4">
            <label class="text-[9px] uppercase font-bold opacity-50">Target Lock</label>
            <button onclick="activateTargetMode()" id="target-btn" class="w-full mt-1 py-2 border border-white/20 rounded-lg text-[10px] font-bold hover:bg-cyan-500/20 hover:border-cyan-500">
                <i class="fa-solid fa-crosshairs"></i> LINK TO ACTOR
            </button>
        </div>

        <div class="mb-4">
             <label class="text-[9px] uppercase font-bold opacity-50 mb-2 block">Color</label>
             <div class="flex gap-2 flex-wrap">
                 <button onclick="setColor('#ff0055')" class="w-6 h-6 rounded-full bg-[#ff0055] ring-1 ring-white/20"></button>
                 <button onclick="setColor('#00f3ff')" class="w-6 h-6 rounded-full bg-[#00f3ff] ring-1 ring-white/20"></button>
                 <button onclick="setColor('#fbbf24')" class="w-6 h-6 rounded-full bg-[#fbbf24] ring-1 ring-white/20"></button>
                 <button onclick="setColor('#10b981')" class="w-6 h-6 rounded-full bg-[#10b981] ring-1 ring-white/20"></button>
                 <button onclick="setColor('#ffffff')" class="w-6 h-6 rounded-full bg-[#ffffff] ring-1 ring-white/20"></button>
             </div>
        </div>

        <div class="border-t border-white/10 pt-4 flex gap-2">
            <button onclick="deleteSelected()" class="flex-1 py-2 bg-red-500/20 text-red-400 text-[10px] font-bold rounded-lg">DELETE</button>
            <button onclick="closeInspector()" class="flex-1 py-2 bg-white/10 text-[10px] font-bold rounded-lg">DONE</button>
        </div>
    </div>

    <div id="obj-controls" class="fixed bottom-24 left-1/2 -translate-x-1/2 glass-panel px-4 py-2 rounded-full hidden items-center gap-4 z-50">
        <button onclick="openInspector()" class="flex flex-col items-center gap-1 text-[9px] font-bold hover:text-cyan-400">
            <i class="fa-solid fa-sliders text-sm"></i> EDIT
        </button>
        <div class="w-px h-6 bg-white/10"></div>
        <button onclick="addMovement()" class="flex flex-col items-center gap-1 text-[9px] font-bold hover:text-green-400">
            <i class="fa-solid fa-person-walking text-sm"></i> MOVE
        </button>
        <div class="w-px h-6 bg-white/10"></div>
        <button onclick="deleteSelected()" class="flex flex-col items-center gap-1 text-[9px] font-bold hover:text-red-400">
            <i class="fa-solid fa-trash text-sm"></i> DEL
        </button>
    </div>

    <script>
        // --- CORE SYSTEM ---
        const world = document.getElementById('world');
        const viewport = document.getElementById('viewport');
        const linesLayer = document.getElementById('lines-layer');
        let objects = [];
        let selectedId = null;
        let scale = 1, panX = 0, panY = 0;
        let isDragging = false;
        let isRotating = false;
        let isResizing = false;
        let targetMode = false;

        // --- MOBILE GESTURES ---
        let pointers = {};
        let initialPinchDist = 0;
        let initialScale = 1;

        viewport.onpointerdown = (e) => {
            if (e.target.closest('.control-handle')) return; // Let handles handle themselves
            if (e.target.closest('.scene-object')) return;   // Let objects handle themselves
            
            pointers[e.pointerId] = e;
            viewport.setPointerCapture(e.pointerId);
            
            if (Object.keys(pointers).length === 2) {
                // Start Pinch
                const p1 = pointers[Object.keys(pointers)[0]];
                const p2 = pointers[Object.keys(pointers)[1]];
                initialPinchDist = Math.hypot(p2.clientX - p1.clientX, p2.clientY - p1.clientY);
                initialScale = scale;
            } else if (Object.keys(pointers).length === 1) {
                isDragging = true;
            }
            deselect();
        };

        viewport.onpointermove = (e) => {
            if (!pointers[e.pointerId]) return;
            pointers[e.pointerId] = e;

            if (Object.keys(pointers).length === 2) {
                // PINCH ZOOM
                const p1 = pointers[Object.keys(pointers)[0]];
                const p2 = pointers[Object.keys(pointers)[1]];
                const dist = Math.hypot(p2.clientX - p1.clientX, p2.clientY - p1.clientY);
                scale = initialScale * (dist / initialPinchDist);
                scale = Math.min(Math.max(0.2, scale), 5); // Clamp zoom
                updateTransform();
                return;
            }

            if (isDragging && Object.keys(pointers).length === 1) {
                // PAN
                panX += e.movementX;
                panY += e.movementY;
                updateTransform();
            }
        };

        viewport.onpointerup = (e) => {
            delete pointers[e.pointerId];
            if (Object.keys(pointers).length === 0) isDragging = false;
        };

        function updateTransform() {
            world.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
            document.getElementById('grid-pattern').style.backgroundPosition = `${-panX}px ${-panY}px`;
        }
        
        // Center initial view
        panX = window.innerWidth / 2;
        panY = window.innerHeight / 2;
        updateTransform();

        // --- OBJECT SYSTEM ---
        function addObject(type, propData = null) {
            const id = 'obj_' + Date.now();
            const el = document.createElement('div');
            el.id = id;
            el.className = 'scene-object group';
            el.style.left = '0px'; el.style.top = '0px';
            el.dataset.type = type;
            el.dataset.rot = 0;
            
            // Visual Content
            let visual = '';
            let label = 'Object';
            
            if (type === 'camera') {
                label = 'CAM A';
                visual = `<div class="fov-cone"></div><div class="cam-body object-visual w-10 h-6"></div>`;
                el.dataset.linkedTo = ''; // For target locking
            } else if (type === 'actor') {
                label = 'Actor';
                visual = `<div class="w-10 h-10 rounded-full bg-rose-500 object-visual shadow-[0_0_15px_rgba(244,63,94,0.4)] relative"><div class="absolute top-0 left-1/2 -translate-x-1/2 w-2 h-2 bg-white rounded-full -mt-1"></div></div>`;
            } else if (type === 'prop') {
                label = propData.name;
                visual = `<div class="prop-visual object-visual border border-white/20 bg-white/5 rounded-lg" style="width:${propData.w}px; height:${propData.h}px"><i class="fa-solid ${propData.icon}"></i></div>`;
            }

            el.innerHTML = `
                ${visual}
                <div class="text-[9px] font-bold mt-2 opacity-70 bg-black/50 px-2 py-0.5 rounded backdrop-blur-sm label-tag">${label}</div>
                <div class="control-handle rotate-handle" onpointerdown="startRotate(event, '${id}')"><i class="fa-solid fa-rotate"></i></div>
                ${type === 'prop' ? `<div class="control-handle resize-handle" onpointerdown="startResize(event, '${id}')"><i class="fa-solid fa-expand"></i></div>` : ''}
            `;

            el.onpointerdown = (e) => startDragObject(e, el);
            world.appendChild(el);
            objects.push({id, el, type, label, x:0, y:0, rot:0, scale:1, linkedTo:null});
            selectObject(id);
            document.getElementById('prop-picker').classList.add('hidden');
        }

        // --- MANIPULATION LOGIC ---
        let activeObj = null;
        let startX, startY, startRot, startW, startH;

        function startDragObject(e, el) {
            if (e.target.classList.contains('control-handle')) return;
            e.stopPropagation();
            selectObject(el.id);
            activeObj = objects.find(o => o.id === el.id);
            
            if (targetMode && activeObj.type === 'actor' && selectedId && objects.find(o=>o.id===selectedId).type === 'camera') {
                // Link Camera to Actor
                linkCameraToActor(selectedId, activeObj.id);
                targetMode = false;
                document.body.style.cursor = 'default';
                return;
            }

            startX = e.clientX; 
            startY = e.clientY;
            el.setPointerCapture(e.pointerId);
            
            el.onpointermove = (ev) => {
                const dx = (ev.clientX - startX) / scale;
                const dy = (ev.clientY - startY) / scale;
                activeObj.x += dx;
                activeObj.y += dy;
                updateObjectDOM(activeObj);
                startX = ev.clientX;
                startY = ev.clientY;
                
                // Update any cameras linked TO this object
                updateLinkedCameras();
            };
            
            el.onpointerup = () => { el.onpointermove = null; el.releasePointerCapture(e.pointerId); };
        }

        function startRotate(e, id) {
            e.stopPropagation();
            const obj = objects.find(o => o.id === id);
            const el = document.getElementById(id);
            const rect = el.getBoundingClientRect();
            const center = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
            
            el.setPointerCapture(e.pointerId);
            
            el.onpointermove = (ev) => {
                const angle = Math.atan2(ev.clientY - center.y, ev.clientX - center.x);
                obj.rot = angle * (180 / Math.PI) + 90; // +90 to align top
                updateObjectDOM(obj);
            };
            
            el.onpointerup = () => { el.onpointermove = null; el.releasePointerCapture(e.pointerId); };
        }

        function startResize(e, id) {
            e.stopPropagation();
            const obj = objects.find(o => o.id === id);
            const el = document.getElementById(id);
            const visual = el.querySelector('.object-visual');
            startX = e.clientX; startY = e.clientY;
            startW = visual.offsetWidth; startH = visual.offsetHeight;
            
            el.setPointerCapture(e.pointerId);
            el.onpointermove = (ev) => {
                const dw = (ev.clientX - startX) / scale;
                const dh = (ev.clientY - startY) / scale;
                visual.style.width = (startW + dw) + 'px';
                visual.style.height = (startH + dh) + 'px';
            };
            el.onpointerup = () => { el.onpointermove = null; el.releasePointerCapture(e.pointerId); };
        }

        function updateObjectDOM(obj) {
            const el = document.getElementById(obj.id);
            el.style.transform = `translate(${obj.x}px, ${obj.y}px) rotate(${obj.rot}deg)`;
            // Counter-rotate label
            const label = el.querySelector('.label-tag');
            if(label) label.style.transform = `rotate(-${obj.rot}deg)`;
        }

        // --- SELECTION & UI ---
        function selectObject(id) {
            deselect();
            selectedId = id;
            document.getElementById(id).classList.add('selected');
            document.getElementById('obj-controls').classList.remove('hidden');
            document.getElementById('obj-controls').classList.add('flex');
            
            // Populate Inspector Data
            const obj = objects.find(o => o.id === id);
            document.getElementById('insp-name').value = obj.label;
            
            if (obj.type === 'camera') document.getElementById('cam-controls').classList.remove('hidden');
            else document.getElementById('cam-controls').classList.add('hidden');
        }

        function deselect() {
            if (selectedId) document.getElementById(selectedId).classList.remove('selected');
            selectedId = null;
            document.getElementById('obj-controls').classList.add('hidden');
            document.getElementById('obj-controls').classList.remove('flex');
            closeInspector();
            targetMode = false;
            document.body.style.cursor = 'default';
        }

        function openInspector() { document.getElementById('inspector').style.transform = 'translateY(-50%) translateX(0)'; }
        function closeInspector() { document.getElementById('inspector').style.transform = 'translateY(-50%) translateX(150%)'; }
        
        function updateLabel(val) {
            if (!selectedId) return;
            const obj = objects.find(o => o.id === selectedId);
            obj.label = val;
            document.getElementById(selectedId).querySelector('.label-tag').innerText = val;
        }

        function setColor(hex) {
            if (!selectedId) return;
            const el = document.getElementById(selectedId).querySelector('.object-visual');
            el.style.backgroundColor = hex;
            el.style.borderColor = hex;
            if(objects.find(o=>o.id===selectedId).type === 'prop') {
                el.style.color = (hex === '#ffffff') ? '#000' : '#fff';
            }
        }

        // --- TARGET LINKING ---
        function activateTargetMode() {
            targetMode = true;
            closeInspector();
            alert("Tap an ACTOR to link this camera.");
            document.body.style.cursor = 'crosshair';
        }

        function linkCameraToActor(camId, actorId) {
            const cam = objects.find(o => o.id === camId);
            cam.linkedTo = actorId;
            updateLinkedCameras();
        }

        function updateLinkedCameras() {
            objects.filter(o => o.type === 'camera' && o.linkedTo).forEach(cam => {
                const target = objects.find(t => t.id === cam.linkedTo);
                if (target) {
                    const angle = Math.atan2(target.y - cam.y, target.x - cam.x);
                    cam.rot = angle * (180 / Math.PI) + 90;
                    updateObjectDOM(cam);
                }
            });
        }

        // --- PROP GENERATOR (150+ Props) ---
        const propCats = {
            'furniture': ['Chair', 'Table', 'Sofa', 'Bed', 'Desk', 'Shelf', 'Lamp', 'Rug'],
            'set': ['Wall', 'Window', 'Door', 'Stairs', 'Pillar', 'Box', 'GreenScreen'],
            'street': ['Car', 'Truck', 'Bike', 'Bench', 'Tree', 'StreetLight', 'Hydrant']
        };
        const icons = { 'Chair': 'fa-chair', 'Car': 'fa-car', 'Tree': 'fa-tree', 'Wall': 'fa-square', 'Lamp': 'fa-lightbulb' };

        function filterProps(cat) {
            const grid = document.getElementById('prop-grid');
            grid.innerHTML = '';
            let list = [];
            if (cat === 'all') Object.values(propCats).forEach(c => list.push(...c));
            else list = propCats[cat] || [];
            
            // Expand list to simulate volume for demo
            if (list.length < 20) list = [...list, ...list, ...list]; 
            
            list.forEach((name, i) => {
                const btn = document.createElement('button');
                btn.className = "aspect-square bg-white/5 border border-white/10 rounded-xl flex flex-col items-center justify-center hover:bg-white/10";
                btn.innerHTML = `<i class="fa-solid ${icons[name] || 'fa-cube'} text-xl mb-2 text-white/70"></i><span class="text-[9px] uppercase">${name} ${i+1}</span>`;
                btn.onclick = () => addObject('prop', {name: name, icon: icons[name] || 'fa-cube', w: 40, h: 40});
                grid.appendChild(btn);
            });
        }
        
        function openPropPicker() { 
            document.getElementById('prop-picker').classList.remove('hidden');
            filterProps('all');
        }

        // --- SAVE SYSTEM ---
        let currentSceneName = "Untitled Scene";

        function toggleSceneMenu() {
            const menu = document.getElementById('scene-menu');
            menu.classList.toggle('hidden');
            if (!menu.classList.contains('hidden')) loadSceneList();
        }

        function saveScene() {
            const name = document.getElementById('scene-name-input').value || currentSceneName;
            currentSceneName = name;
            document.getElementById('scene-name-display').innerText = name;
            
            // Serialize
            const sceneData = {
                name: name,
                objects: objects.map(o => {
                    // Get visual size for props
                    const el = document.getElementById(o.id).querySelector('.object-visual');
                    return {...o, w: el.offsetWidth, h: el.offsetHeight};
                })
            };
            
            localStorage.setItem('cineflow_' + name, JSON.stringify(sceneData));
            alert("Scene Saved!");
            toggleSceneMenu();
        }

        function loadSceneList() {
            const list = document.getElementById('saved-list');
            list.innerHTML = '';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('cineflow_')) {
                    const name = key.replace('cineflow_', '');
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center p-2 bg-white/5 rounded-lg";
                    div.innerHTML = `
                        <span class="text-xs font-bold">${name}</span>
                        <div class="flex gap-2">
                            <button onclick="loadScene('${name}')" class="text-xs text-green-400">LOAD</button>
                            <button onclick="deleteScene('${name}')" class="text-xs text-red-400">DEL</button>
                        </div>
                    `;
                    list.appendChild(div);
                }
            }
        }

        function loadScene(name) {
            const data = JSON.parse(localStorage.getItem('cineflow_' + name));
            currentSceneName = data.name;
            document.getElementById('scene-name-display').innerText = data.name;
            document.getElementById('scene-name-input').value = data.name;
            
            // Clear current
            world.innerHTML = '<div id="grid-pattern"></div><div id="lines-layer"></div>';
            objects = [];
            
            // Rebuild
            data.objects.forEach(o => {
                addObject(o.type, {name: o.label, icon: 'fa-cube', w: o.w, h: o.h});
                const newObj = objects[objects.length-1];
                newObj.x = o.x; newObj.y = o.y; newObj.rot = o.rot; newObj.label = o.label;
                newObj.linkedTo = o.linkedTo;
                updateObjectDOM(newObj);
                // Visual color update would go here if saved
            });
            toggleSceneMenu();
        }
        
        function downloadScene() {
            const data = JSON.stringify({name: currentSceneName, objects: objects});
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentSceneName + '.json';
            a.click();
        }

        function createNewScene() {
            if(confirm("Clear current scene?")) {
                world.innerHTML = '<div id="grid-pattern"></div><div id="lines-layer"></div>';
                objects = [];
                currentSceneName = "Untitled Scene";
                document.getElementById('scene-name-display').innerText = currentSceneName;
                toggleSceneMenu();
            }
        }

        function deleteScene(name) {
            localStorage.removeItem('cineflow_' + name);
            loadSceneList();
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
        }

        function deleteSelected() {
            if (selectedId) {
                document.getElementById(selectedId).remove();
                objects = objects.filter(o => o.id !== selectedId);
                deselect();
            }
        }
    </script>
</body>
</html>
